<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hôm Nay Ăn gì</title>
    <link rel="stylesheet" href="./css/common.css">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="./css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="./js/jquery.min.js"></script>

    <!-- Popper JS -->
    <script src="./js/popper.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="./js/bootstrap.min.js"></script>
</head>
<body class="body">
    <div class="wrapper">
        <div class="container-fluid .pt-3">
            <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
                <ul class="navbar-nav">
                    <li class="nav-item active">
                        <a class="nav-link" href="">Hôm Nay Ăn gì</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./sodu.html">Số dư</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./chitiet.html">Chi tiết</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./thanhvien.html">Thành viên</a>
                    </li>
                </ul>
            </nav>
            <section class="container-fluid mt-5">
                <div id="intent1">
                    <div class="row d-flex flex-row">
                        <div class="col-3">
                            <label for="date">Ngày:</label>
                        </div>
                        <div class="col-9">
                            <input id="datePicker" type="date" name="datePicker"
                                onchange="console.log(this.value);" />
                        </div>
                    </div>
                    <hr />
                    <div>
                        <input type="button" value="Nhập hóa đơn" onclick="nhaphoadon()" />
                    </div>
                    <div class="row d-flex flex-row">
                        <div class="col-2">
                            <label for="date">Tham gia: <span id="total">0</span></label>
                        </div>
                        <div class="col-8">
                            <div class="row" id="addon">

                            </div>
                        </div>
                        <div class="col-1">
                            <input type="button" id="addid" value="+" onclick="newmem()" />
                        </div>
                    </div>
                    <div id="addnew" style="display:none">
                        <hr />
                        <div class="row d-flex flex-row">
                            <div class="col-3">
                                <label>Tên:</label>
                            </div>
                            <div class="col-9">
                                <input id="txtName" type="text" onchange="console.log(this.value);" />
                            </div>
                        </div>
                        <div class="row d-flex flex-row">
                            <div class="col-3">
                                <label>Giới tính:</label>
                            </div>
                            <div class="col-9">
                                <input type="radio" id="male" name="gender" value="male" checked="checked">
                                <label for="male">Nam</label>
                                <input type="radio" id="female" name="gender" value="female">
                                <label for="female">Nữ</label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-3">
                            </div>
                            <div class="col-9">
                                <input type="button" value="Thêm" onclick="addnewmem()" />
                            </div>
                        </div>
                    </div>
                    <hr />
                    <div class="row">
                        <div class="col-3">
                            <label for="date">Thêm người tham gia: </label>
                        </div>
                        <div class="col-8">
                            <div class="row" id="addout">
                            </div>
                        </div>
                    </div>
                </div>
                <div id="intent2" style="display:none">
                    <div>
                        <input type="button" value="Quay lại" onclick="back1()" />
                        <input type="button" value="Tổng kết" onclick="Sum()" />
                    </div>
                    <h4>
                        Hóa đơn ngày <span id="ngay"></span>
                    </h4>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Tên</th>
                                <th>Mặc hàng</th>
                                <th>Giá</th>
                                <th>Xóa</th>
                            </tr>
                        </thead>
                        <tbody id="banggia">
                        </tbody>
                    </table>
                    <hr />
                    <div class="row d-flex flex-row">
                        <div class="col-3">
                            Tổng:
                        </div>
                        <div class="col-9">
                            <span id="tong">0</span>
                        </div>
                    </div>
                    <hr />
                    <div>
                        <div class="row d-flex flex-row">
                            <div class="col-3">
                                <label>Tên:</label>
                            </div>
                            <div class="col-9" id="select">
                                <!--<input id="txtName" type="text" onchange="console.log(this.value);" />-->
                            </div>
                        </div>
                        <div class="row d-flex flex-row">
                            <div class="col-3">
                                <label>Hóa đơn:</label>
                            </div>
                            <div class="col-9">
                                <input id="txtHoadon" type="text" onchange="console.log(this.value);" />
                            </div>
                        </div>
                        <div class="row d-flex flex-row">
                            <div class="col-3">
                                <label>Giá:</label>
                            </div>
                            <div class="col-9">
                                <input id="txtGia" type="number" onchange="console.log(this.value);" />
                            </div>
                        </div>
                        <div class="row d-flex flex-row">
                            <div class="col-3">
                            </div>
                            <div class="col-9">
                                <input type="button" value="Thêm" onclick="Them()" />
                            </div>
                        </div>
                    </div>
                </div>
                <div id="intent3" style="display:none">
                    <div class="row d-flex flex-row">
                        <div class="col-12">
                            <input type="button" value="Quay lại" onclick="back2()" />
                            <input type="button" value="Tính nhanh" id="btntinhnhanh" onclick="TinhNhanh(this)" />
                            <input type="button" value="Đặc biệt" id="btndacbiet" onclick="DacBiet(this)" />
                        </div>
                        <!-- <div class="col-4">
                            <input type="button" value="Tính nhanh" id="btntinhnhanh" onclick="TinhNhanh(this)" />
                        </div>
                        <div class="col-4">
                            <input type="button" value="Đặc biệt" id="btndacbiet" onclick="DacBiet(this)" />
                        </div> -->
                    </div>
                    <div id="tbtotal">
                        <h4>
                            Hóa đơn ngày <span id="ngay2"></span>
                        </h4>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Tên</th>
                                    <th>Tiền Chi</th>
                                    <th>Tiền Tổng Kết</th>
                                    <th>Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody id="banggia2">
                            </tbody>
                        </table>
                        <div>
                            Trung bình: <span id="binhquan"></span>
                        </div>
                        <hr />
                    </div>
                    <!-- <div class="row d-flex flex-row">
                        <div class="col-3">
                            <input type="button" value="Tính nhanh" id="btntinhnhanh" onclick="TinhNhanh(this)" />
                            <input type="button" value="Đặc biệt" id="btndacbiet" onclick="DacBiet(this)" />
                        </div>
                    </div> -->
                    <hr />
                    <div id="tinhnhanh" style="display:none">
                        Tổng: <span id="tongcacu">0</span>
                        <hr />
                        <span>Đã Chọn : </span>
                        <div class="row" id="addon2">

                        </div>
                        
                        <hr />
                        <span>Chọn : </span>
                        <div class="row" id="addout2">

                        </div>
                    </div>
                    <div id="dacbiet" style="display:none">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Tên</th>
                                    <th>Tiền Thiết Lập</th>
                                    <th>Xóa</th>
                                </tr>
                            </thead>
                            <tbody id="banggia3">
                            </tbody>
                        </table>
                        <hr />
                        <div class="row d-flex flex-row">
                            <div class="col-3">
                                <label>Tên:</label>
                            </div>
                            <div class="col-9" id="select">
                                <div id="select2"></div>
                                <!--<input id="txtName" type="text" onchange="console.log(this.value);" />-->
                            </div>
                        </div>
                        <div class="row d-flex flex-row">
                            <div class="col-3">
                                <label>Tiền Thiết Lập:</label>
                            </div>
                            <div class="col-9">
                                <input id="txtGia2" type="number" onchange="console.log(this.value);" />
                            </div>
                        </div>
                        <div>
                            <input type="button" value="Thêm" onclick="Themdb()" />
                            <input type="button" value="Tổng Kết" onclick="SumDB()" />
                        </div>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Tên</th>
                                    <th>Tiền Chi</th>
                                    <th>Tiền Tổng Kết</th>
                                    <th>Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody id="banggia4">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </div>
    <script>
        var count = 0;
        var counttb = 0;
        var counttb2 = 0;
        var arrname = [];
        var currentObjUser = {};
        var currentDate = { ngay: "",person:[{ ID: 0, chitiet: [{hoadon:"",gia:0}], tong: 0 }], tong: 0}
        var list = [];
        var obj = null;
        var listdacbiet = [];
        $(document).ready(function () {
            var storage = localStorage.getItem('UserDB');
            if (!storage) {
                var UserDB = [
                    //cmt
                    { ID: 0, name: "Linh", avatar: 'Linh.jpg', isBoss: 1 }
                    , { ID: 1, name: "Cảnh", avatar: 'canh.jpg', isBoss: 1 }
                    , { ID: 2, name: "Tân", avatar: 'tantan.jpg', isBoss: 1 }
                    , { ID: 3, name: "Thăng",avatar: 'Thang.jpg', isBoss: 1 }
                    , { ID: 4, name: "Lùn", avatar: 'lun.png', isBoss: 1 }
                    , { ID: 5, name: "Hùng", avatar: 'hung.png', isBoss: 1 }
                    , { ID: 6, name: "Nam", avatar: 'nam.png', isBoss: 1 }
                    , { ID: 7, name: "Thanh", avatar: 'thanh.png', isBoss: 1 }];
                localStorage.setItem('UserDB', JSON.stringify(UserDB));
                storage = localStorage.getItem('UserDB');
            }
            obj = JSON.parse(storage);
            var arr = [];
            obj.forEach(x=>{arr.push(x.ID)});
            var x = arr.sort();
            count = x.length ==0 ? 0 : Number(x[x.length-1]) + 1;
            obj.forEach((val,i) => {
                var ava = val.avatar.indexOf("data") == 0 ? val.avatar : `img/${val.avatar}`
                var b = $(`<div class="col-2" id="member${val.ID}" onclick="add(this,${val.ID});">`);
                var c = $('<div class="row">');
                var d = $(`<img src="${ava}" alt="Avatar" class="avatar">`);
                var e = $('<div class="row">');
                var f = $(`<span>${val.name}</span>`);
                c.append(d);
                e.append(f);
                b.append(c, e);
                $("#addout").append(b);
            })
            //console.log(new Date().toJSON().slice(0, 10).replace(/-/g, '/'))
            $('#datePicker').val(new Date().toJSON().slice(0, 10));
        });
        const add = (ele, id) => {
            //alert(ele.id)
            var e = $("#" + ele.id);
            // var index = ele.id.match(/\d{1,999}/);
            // var ind = Number(index[0]) - 1;
            //var x = obj.filter(val => val.ID == ind)[0];
            if (e.parent().attr('id') == 'addon') {//xoa
                if (ele.id.includes('memberadd')) {
                    e.remove();
                    // count--;
                } else {
                    $("#addout").append(e);
                }
                list = list.filter((val) => val.ID != id);
                var c = list.length; 
                $("#total").text(c);
            } else {//them
                $("#addon").append(e);
                var x = obj.filter(val => val.ID == id)[0];
                list.push(x);
                var c = list.length; 
                $("#total").text(c);
            }
            console.log(list)
        }
        const newmem = () => {
            if ($('#addid').val() == "+") {
                $('#addid').val('-');
                $('#addnew').css("display", 'block');
            } else {
                $('#addid').val('+');
                $('#addnew').css("display", 'none');
            }
        }

        const addnewmem = () => {
            if ($('#txtName').val() != '') {
                var radioValue = $("input[name='gender']:checked").val();
                var gender = radioValue == 'male' ? 'avatar' : 'avatar2';
                var b = $(`<div class="col-2" id="memberadd${count}" onclick="add(this, ${count});">`);
                var c = $('<div class="row">');
                var d = $(`<img src="img/${gender}.png" alt="Avatar" class="avatar">`);
                var e = $('<div class="row">');
                var f = $('<span>' + $('#txtName').val() + '</span>');
                c.append(d);
                e.append(f);
                b.append(c, e);
                // var genderi = radioValue == 'male' ? 1 : 0;
                currentObjUser = { ID: count, name: $('#txtName').val(), avatar: gender + ".png", isBoss: 0 }
                list.push(currentObjUser);
                var c = list.length;
                $("#total").text(c);
                $("#addon").append(b);
                $('#addid').val('+');
                $('#txtName').val('');
                $("#male").prop('checked', true);
                $('#addnew').css("display", 'none');
                count++;
                //$("#total").text(Number($("#total").text()) + 1);
            }
        }
        const nhaphoadon = () => {
            if (list.length == 0) {
                return;
            }
            $('#intent1').css("display", 'none');
            $('#intent2').css("display", 'block');
            $('#ngay').text($('#datePicker').val());
            var sel = $('<select id="selecthd">').appendTo('#select');
            list.forEach((val)=> {
                sel.append($("<option>").attr('value', val.ID).text(val.name));
            });
            var per = [];
            list.forEach((val) => {
                var objper = {};
                objper.ID = val.ID;
                objper.chitiet = [];
                objper.tong = 0;
                per.push(objper);
            })
            currentDate = { ngay: $('#datePicker').val(), person: per, tong: 0 }
        }
        const back1 = () => {
            $('#intent1').css("display", 'block');
            $('#intent2').css("display", 'none');
            $('#ngay').text('');
            $('#select').empty();
            $('#banggia').empty();
            $('#tong').text('0');
            currentDate = {}
        }
        const Them = () => {
            if ($('#txtGia').val() == '') { return; }
            var curtong = Number($("#tong").text());
            var gia = Number($("#txtGia").val());
            var indexhd = 0;
            currentDate.person.forEach(y => {
                if (y.ID == $("#selecthd option:selected").val()) {
                    indexhd = y.chitiet.length;
                    y.chitiet.push({hoadon: $("#txtHoadon").val(), gia: $("#txtGia").val() })
                    var t = Number(y.tong);
                    var g = Number($("#txtGia").val());
                    y.tong = t + g;
                }
            })
            currentDate.tong = curtong + gia;
            console.log(currentDate);
            var a = $('#banggia');
            var b = $(`<tr id="tr${counttb}"></tr>`);
            var c = $(`<td>${$("#selecthd option:selected").text()}</td>`);
            var d = $(`<td>${$("#txtHoadon").val()}</td>`);
            var e = $(`<td id="td${counttb}">${$("#txtGia").val()}</td>`);
            var f = $(`<td><input type="button" value="Xóa" onclick="Delete(${counttb},${$('#selecthd option:selected').val()},${indexhd})" /></td>`);
            counttb++;
            b.append(c, d, e, f);
            a.append(b);
            $("#tong").text(curtong + gia);
            $("#txtHoadon").val('');
            $("#txtGia").val('');

        }

        const Delete = (i, id, idhd) => {
            console.log(id)
            var curtong = Number($("#tong").text());
            var gia = Number($(`#td${i}`).text());
            $("#tong").text(curtong - gia);
            $(`#tr${i}`).remove();
            currentDate.person.forEach(y => {
                if (y.ID == id) {
                    var g = y.chitiet[Number(idhd)].gia;
                    var t = Number(y.tong);
                    y.chitiet.splice(Number(idhd),1);
                    y.tong = t - g;
                }
            })
            currentDate.tong = curtong - gia;
            console.log(currentDate);
        }

        const Sum = () => {
            if ($("#tong").text() == '0') {
                return;
            }
            $('#intent2').css("display", 'none');
            $('#intent3').css("display", 'block');
            $('#ngay2').text($('#datePicker').val());
            var per = Math.round(currentDate.tong / (list.length));
            var a = $('#banggia2');
            list.forEach((val) => {
                var gia = 0;
                currentDate.person.forEach(y => {
                    if (y.ID == val.ID) {
                        gia = Number(y.tong);
                    }
                })
                var b = $(`<tr></tr>`);
                var c = $(`<td>${val.name}</td>`);
                var d = $(`<td>${gia}</td>`);
                var e = $(`<td id="td2${counttb}">${per - gia}</td>`);
                var g = $(`<td><input type="checkbox" id="cb${counttb}" value="Thanh toán"> <label for="cb${counttb}"> Thanh toán</label><br></td>`);
                counttb++;
                b.append(c, d, e, g);
                a.append(b);
            })
            $('#binhquan').text(per);
            list.forEach((val, i) => {
                var ava = val.avatar.indexOf("data") == 0 ? val.avatar : `img/${val.avatar}`
                var b = $(`<div class="col-2" id="member_${val.ID}" onclick="add2(this);">`);
                var c = $('<div class="row">');
                var d = $(`<img src="${ava}" alt="Avatar" class="avatar">`);
                var e = $('<div class="row">');
                var f = $(`<span>${val.name}</span>`);
                c.append(d);
                e.append(f);
                b.append(c, e);
                $("#addout2").append(b);
            })
            
        }
        const back2 = () => {
            $('#intent2').css("display", 'block');
            $('#intent3').css("display", 'none');
            $('#ngay2').text('');
            $('#banggia2').empty();
            $("#addout2").empty();
            $("#addon2").empty();
            $('#tongcacu').text('0');
            $('#binhquan').text('');
        }

        const TinhNhanh = (e) => {
            var x = document.getElementById('btndacbiet');
            if (e.value == "Tính nhanh") {
                e.value = "Hủy";
                $('#tinhnhanh').css("display", 'block');
                $('#dacbiet').css("display", 'none');
                $('#tbtotal').css("display", 'none');
                $('#select2').empty();
                $('#btndacbiet').val('Đặc biệt');
            } else {
                e.value = "Tính nhanh";
                $('#tinhnhanh').css("display", 'none');
                $('#tbtotal').css("display", 'table');
            }
        }

        const add2 = (ele) => {
            //alert(ele.id)
            var e = $("#" + ele.id);
            var index = ele.id.match(/\d{1,999}/);
            var ind = Number(index[0]);
            var tong = Number($('#tongcacu').text())
            //var x = obj.filter(val => val.ID == ind)[0];
            var per = Math.round(currentDate.tong / (list.length));
            if (e.parent().attr('id') == 'addon2') {//xoa
                $("#addout2").append(ele);
                currentDate.person.forEach(y => {
                    if (y.ID == ind) {
                        var gia = Number(y.tong);
                        $('#tongcacu').text(tong - (per - gia));
                    }
                })
            } else {//them
                $("#addon2").append(ele);
                currentDate.person.forEach(y => {
                    if (y.ID == ind) {
                        var gia = Number(y.tong);
                        $('#tongcacu').text(tong + (per - gia));
                    }
                })
            }
            console.log(list)
        }
        const DacBiet = (e) => {
            if (e.value == "Đặc biệt") {
                e.value = "Hủy";
                $('#dacbiet').css("display", 'block');
                $('#tinhnhanh').css("display", 'none');
                $('#tbtotal').css("display", 'none');
                $('#btntinhnhanh').val("Tính nhanh");
                $('#select2').empty();
                var con = $('#selecthd').html();
                var sel = $('<select id="selectten">').appendTo('#select2');
                sel.append($(con))
            } else {
                e.value = "Đặc biệt";
                $('#dacbiet').css("display", 'none');
                $('#tbtotal').css("display", 'table');
            }
            
        }
        const Themdb = () => {
            var x = arrname.indexOf($("#selectten option:selected").text());
            if (x != -1) {
                alert('Trùng tên rồi \n Chọn tên khác đi');
                return;
            }
            var tien = Number($("#txtGia2").val());
            if ($("#txtGia2").val() == '' || tien > currentDate.tong) {
                alert('Cao hơn tiền tổng rồi');
                return;
            }
            var a = $('#banggia3');
            var b = $(`<tr id="trdb${counttb2}"></tr>`);
            var c = $(`<td id="tddb1${counttb2}">${$("#selectten option:selected").text()}</td>`);
            var e = $(`<td id="tddb2${counttb2}">${$("#txtGia2").val()}</td>`);
            var f = $(`<td><input type="button" value="Xóa" onclick="Delete2(${counttb2},'${$('#selectten option:selected').text()}',${$('#selectten option:selected').val()})" /></td>`);
            counttb2++;
            b.append(c, e, f);
            a.append(b);
            arrname.push($("#selectten option:selected").text())
            var obj = {};
            obj.val = Number($('#selectten option:selected').val());
            obj.tien = tien;
            listdacbiet.push(obj);
        }
        const Delete2 = (id, text, val) => {
            var x = arrname.indexOf(text);
            arrname.splice(x, 1);
            $(`#trdb${id}`).remove();
            var index = -1;
            listdacbiet.forEach((val,i)=>{if(val.val == val) {index = i;}})
            listdacbiet.splice(index,1);
        }

        const SumDB = ()=> {
            var no = 0;
            var tong = currentDate.tong;
            var arrID = [];
            listdacbiet.forEach((val)=>{
                arrID.push(val.val);
                tong = tong - val.tien;
            })

            var per = Math.round(tong / (list.length-listdacbiet.length));
            var a = $('#banggia4');
            a.empty();
            console.log(arrID)
            console.log(arrID.includes(0))
            var x = list.filter(m=>!arrID.includes(m.ID))
            x.forEach((val) => {
                var gia = 0;
                currentDate.person.forEach(y => {
                    if (y.ID == val.ID) {
                        gia = Number(y.tong);
                    }
                })
                var b = $(`<tr></tr>`);
                var c = $(`<td>${val.name}</td>`);
                var d = $(`<td>${gia}</td>`);
                var e = $(`<td>${per - gia}</td>`);
                var g = $(`<td><input type="checkbox" id="cb${no}" value="Thanh toán"> <label for="cb${no}"> Thanh toán</label><br></td>`);
                b.append(c, d, e, g);
                a.append(b);
            })
        }
    </script>
</body>
</html>
