<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hôm Nay Ăn gì</title>
    <link rel="stylesheet" href="./css/common.css">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="./css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="./js/jquery.min.js"></script>

    <!-- Popper JS -->
    <script src="./js/popper.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="./js/bootstrap.min.js"></script>
    <script src="./js/constant.js"></script>
    <script src="./js/common.js"></script>
    <script src="./js/index.js"></script>
    <script src="./js/hangvn.js"></script>
</head>
<body class="body">
    <div class="wrapper">
        <div class="container-fluid .pt-3">
            <nav class="navbar navbar-dark bg-dark">
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarToggleExternalContent" aria-controls="navbarToggleExternalContent" aria-expanded="false" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon"></span>
                </button>
            </nav>
            <div class="collapse navbar navbar-expand-sm bg-dark navbar-dark" id="navbarToggleExternalContent">
                <ul class="navbar-nav">
                    <li class="nav-item active">
                        <a class="nav-link" href="">Hôm Nay Ăn gì</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./sodu.html">Số dư</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./chitiet.html">Chi tiết</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./thanhvien.html">Thành viên</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./hangvn.html">Mua Hàng VN</a>
                    </li>
                </ul>
            </div>
            <section class="pd-t-5">
                <div id="intent1">
                    <div class="row d-flex flex-row">
                        <div class="col-3">
                            <label for="date">Ngày:</label>
                        </div>
                        <div class="col-9">
                            <input id="datePicker" type="date" name="datePicker"
                                onchange="console.log(this.value);" />
                        </div>
                    </div>
                    <hr />
                    <div>
                        <input type="button" value="Nhập hóa đơn" onclick="nhaphoadon()" />
                    </div>
                    <div class="row d-flex flex-row">
                        <div class="col-2">
                            <label for="date">Tham gia: <span id="total">0</span></label>
                        </div>
                        <div class="col-8">
                            <div class="row" id="addon">

                            </div>
                        </div>
                        <div class="col-1">
                            <input type="button" id="addid" value="+" onclick="newmem()" />
                        </div>
                    </div>
                    <div id="addnew" style="display:none">
                        <hr />
                        <div class="row d-flex flex-row">
                            <div class="col-3">
                                <label>Tên:</label>
                            </div>
                            <div class="col-9">
                                <input id="txtName" type="text" onchange="console.log(this.value);" />
                            </div>
                        </div>
                        <div class="row d-flex flex-row">
                            <div class="col-3">
                                <label>Giới tính:</label>
                            </div>
                            <div class="col-9">
                                <input type="radio" id="male" name="gender" value="male" checked="checked">
                                <label for="male">Nam</label>
                                <input type="radio" id="female" name="gender" value="female">
                                <label for="female">Nữ</label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-3">
                            </div>
                            <div class="col-9">
                                <input type="button" value="Thêm" onclick="addnewmem()" />
                            </div>
                        </div>
                    </div>
                    <hr />
                    <div class="row">
                        <div class="col-3">
                            <label for="date">Thêm người tham gia: </label>
                        </div>
                        <div class="col-8">
                            <div class="row" id="addout">
                            </div>
                        </div>
                    </div>
                </div>
                <div id="intent2" style="display:none">
                    <div>
                        <input type="button" value="Quay lại" onclick="back1()" />
                        <input type="button" value="Tổng kết" onclick="Sum()" />
                    </div>
                    <h4>
                        Hóa đơn ngày <span id="ngay"></span>
                    </h4>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Tên</th>
                                <th>Mặc hàng</th>
                                <th>Giá</th>
                                <th>Xóa</th>
                            </tr>
                        </thead>
                        <tbody id="banggia">
                        </tbody>
                    </table>
                    <hr />
                    <div class="row d-flex flex-row">
                        <div class="col-3">
                            Tổng:
                        </div>
                        <div class="col-9">
                            <span id="tong">0</span>
                        </div>
                    </div>
                    <hr />
                    <div>
                        <input type="button" value="Hoá đơn lẻ" onclick="Hoadonle()"/>
                        <input type="button" value="Hoá có sẵn" onclick="Hoadoncosan()"/>
                    </div>
                    <div id="hoadonle" style="padding-top: 20px;">
                        <div class="row d-flex flex-row">
                            <div class="col-3">
                                <label>Tên:</label>
                            </div>
                            <div class="col-9" id="select">
                                <!--<input id="txtName" type="text" onchange="console.log(this.value);" />-->
                            </div>
                        </div>
                        <div class="row d-flex flex-row">
                            <div class="col-3">
                                <label>Hóa đơn:</label>
                            </div>
                            <div class="col-9">
                                <input id="txtHoadon" type="text" onchange="console.log(this.value);" />
                            </div>
                        </div>
                        <div class="row d-flex flex-row">
                            <div class="col-3">
                                <label>Giá:</label>
                            </div>
                            <div class="col-9">
                                <input id="txtGia" type="number" onchange="console.log(this.value);" />
                            </div>
                        </div>
                        <div class="row d-flex flex-row">
                            <div class="col-3">
                            </div>
                            <div class="col-9">
                                <input type="button" value="Thêm" onclick="Them()" />
                            </div>
                        </div>
                    </div>
                    <div id="hoadoncosan" style="padding-top: 20px;display: none;">
                        <div class="row d-flex flex-row">
                            <div class="col-sm-3">
                                <label>Tên Hóa đơn:</label>
                            </div>
                            <div class="col-sm-9" id="selecthdcs">
                            </div>
                        </div>
                        <div class="row d-flex flex-row">
                            <div class="col-sm-3">
                                <label>Tên mặt hàng:</label>
                            </div>
                            <div class="col-sm-9" id="selecthdcs_mh">
                            </div>
                        </div>
                        <div class="row d-flex flex-row">
                            <div class="col-sm-3">
                                <label>Số lượng:</label>
                            </div>
                            <div class="col-sm-9" id="selecthdcs_sl">
                            </div>
                        </div>
                        <div class="row d-flex flex-row">
                            <div class="col-sm-3">
                                <label>Giá:</label>
                            </div>
                            <div class="col-sm-9" id="selecthdcs_sl">
                                <label id="giahdcs"></label>
                            </div>
                        </div>
                        <div class="row d-flex flex-row">
                            <div class="col-sm-3">
                            </div>
                            <div class="col-sm-9">
                                <input type="button" value="Thêm" onclick="HangVN.Themhdcs()" />
                            </div>
                        </div>
                    </div>
                </div>
                <div id="intent3" style="display:none">
                    <div class="row d-flex flex-row">
                        <div class="col-12">
                            <input type="button" value="Quay lại" onclick="back2()" />
                            <input type="button" value="Tính nhanh" id="btntinhnhanh" onclick="TinhNhanh(this)" />
                            <input type="button" value="Đặc biệt" id="btndacbiet" onclick="DacBiet(this)" />
                        </div>
                        <!-- <div class="col-4">
                            <input type="button" value="Tính nhanh" id="btntinhnhanh" onclick="TinhNhanh(this)" />
                        </div>
                        <div class="col-4">
                            <input type="button" value="Đặc biệt" id="btndacbiet" onclick="DacBiet(this)" />
                        </div> -->
                    </div>
                    <div id="tbtotal">
                        <h4>
                            Hóa đơn ngày <span id="ngay2"></span>
                        </h4>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Tên</th>
                                    <th>Tiền Chi</th>
                                    <th>Tiền Tổng Kết</th>
                                    <th>Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody id="banggia2">
                            </tbody>
                        </table>
                        <div>
                            Trung bình: <span id="binhquan"></span>
                        </div>
                        <hr />
                    </div>
                    <!-- <div class="row d-flex flex-row">
                        <div class="col-3">
                            <input type="button" value="Tính nhanh" id="btntinhnhanh" onclick="TinhNhanh(this)" />
                            <input type="button" value="Đặc biệt" id="btndacbiet" onclick="DacBiet(this)" />
                        </div>
                    </div> -->
                    <hr />
                    <div id="tinhnhanh" style="display:none">
                        Tổng: <span id="tongcacu">0</span>
                        <hr />
                        <span>Đã Chọn : </span>
                        <div class="row" id="addon2">

                        </div>
                        <hr />
                        <span>Chọn : </span>
                        <div class="row" id="addout2">

                        </div>
                    </div>
                    <div id="dacbiet" style="display:none">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Tên</th>
                                    <th>Tiền Thiết Lập</th>
                                    <th>Xóa</th>
                                </tr>
                            </thead>
                            <tbody id="banggia3">
                            </tbody>
                        </table>
                        <hr />
                        <div class="row d-flex flex-row">
                            <div class="col-3">
                                <label>Tên:</label>
                            </div>
                            <div class="col-9" id="select">
                                <div id="select2"></div>
                                <!--<input id="txtName" type="text" onchange="console.log(this.value);" />-->
                            </div>
                        </div>
                        <div class="row d-flex flex-row">
                            <div class="col-3">
                                <label>Tiền Thiết Lập:</label>
                            </div>
                            <div class="col-9">
                                <input id="txtGia2" type="number" onchange="console.log(this.value);" />
                            </div>
                        </div>
                        <div>
                            <input type="button" value="Thêm" onclick="Themdb()" />
                            <input type="button" value="Tổng Kết" onclick="SumDB()" />
                        </div>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Tên</th>
                                    <th>Tiền Chi</th>
                                    <th>Tiền Tổng Kết</th>
                                    <th>Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody id="banggia4">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </div>
    <script>
        $(document).ready(function () {
            User.createNewUserDB();
            Index.createNewListUser();
            History.createNewHistory();
            var obj = User.getUserDB();
            Index.addListAvatar(obj,"addout");
            $('#datePicker').val(new Date().toJSON().slice(0, 10));
        });

        // ngay 2-7-2021------------------------------------
        const Hoadonle = ()=>{
            Common.An('hoadoncosan');
            Common.Hienthi('hoadonle');
        }
        const Hoadoncosan= ()=>{
            var hd = HangVN.getHoaDon();
            if(hd == null || hd.length == 0) {
                alert('Không có hóa đơn nào!')
                return;
            }
            Common.An('hoadonle');
            Common.Hienthi('hoadoncosan');
            var id1 = HangVN.createSelect_Tenhoadon("selecthdcs","idhdccs");
            var id2 = HangVN.createSelect_mathang("selecthdcs_mh","idhdccs_mh", id1);
            HangVN.createSelect_soluong("selecthdcs_sl","idhdccs_sl", id1, id2);
        }
        const Themhdcs = ()=>{
        }
        // ngay 2-7-2021------------------------------------
        const add = (ele, id) => {
            var e = $("#" + ele.id);
            if (e.parent().attr('id') == 'addon') {//xoa
                if (ele.id.includes('memberadd')) {
                    e.remove();
                } else {
                    $("#addout").append(e);
                }
                Index.deleteListUser(id);
            } else {//them
                $("#addon").append(e);
                Index.addListUserId(id);
            }
            var c = Index.getListLenght(); 
                $("#total").text(c);
        }
        const newmem = () => {
            if ($('#addid').val() == "+") {
                $('#addid').val('-');
                $('#addnew').css("display", 'block');
            } else {
                $('#addid').val('+');
                $('#addnew').css("display", 'none');
            }
        }

        const addnewmem = () => {
            if ($('#txtName').val() != '') {
                var radioValue = $("input[name='gender']:checked").val();
                var gender = radioValue == 'male' ? 'avatar' : 'avatar2';
                var newID = Index.createUser($('#txtName').val(),`${gender}.png`,2);
                var b = $(`<div class="col-2" id="memberadd${newID}" onclick="add(this, ${newID});">`);
                var c = $('<div class="row">');
                var d = $(`<img src="img/${gender}.png" alt="Avatar" class="avatar">`);
                var e = $('<div class="row">');
                var f = $('<span>' + $('#txtName').val() + '</span>');
                c.append(d);
                e.append(f);
                b.append(c, e);
                var total = Index.getListLenght();
                $("#total").text(total);
                $("#addon").append(b);
                $('#addid').val('+');
                $('#txtName').val('');
                $("#male").prop('checked', true);
                $('#addnew').css("display", 'none');
            } else {
                alert('Nhập tên vào đi cưng!');
            }
        }
        const nhaphoadon = () => {
            if (Index.getListLenght() == 0) {
                alert('Chọn 1 người tham gia đi chứ!\nClick avatar hoặc nút [+]');
                return;
            }
            Common.An('intent1');
            Common.Hienthi('intent2');
            $('#ngay').text($('#datePicker').val());
            Index.createSelect('select','selecthd');
            Index.deleteCurrentDate();
            Index.createCurrentDate($('#datePicker').val());
        }
        const back1 = () => {
            $('#intent1').css("display", 'block');
            $('#intent2').css("display", 'none');
            $('#ngay').text('');
            $('#select').empty();
            $('#banggia').empty();
            $('#tong').text('0');
            // currentDate = {}
        }
        const Them = () => {
            if ($('#txtGia').val() == '') {
                alert('Nhập số tiền đã mua đi nào!'); 
                return; 
            }
            var curtong = Number($("#tong").text());
            var id = $("#selecthd option:selected").val();
            var hoadon = $("#txtHoadon").val();
            var gia = Number($("#txtGia").val());
            var idhoadon = Index.newChitiet(id,hoadon,gia);
            var a = $('#banggia');
            var b = $(`<tr id="tr${id}_${idhoadon}"></tr>`);
            var c = $(`<td>${$("#selecthd option:selected").text()}</td>`);
            var d = $(`<td>${hoadon}</td>`);
            var e = $(`<td>${gia}</td>`);
            var f = $(`<td><input type="button" value="Xóa" onclick="Delete(${id},${idhoadon})" /></td>`);
            b.append(c, d, e, f);
            a.append(b);
            $("#tong").text(curtong + gia);
            $("#txtHoadon").val('');
            $("#txtGia").val('');

        }

        const Delete = (id, idhoadon) => {
            console.log(id)
            $(`#tr${id}_${idhoadon}`).remove();
            var tong = Index.deleteChitiet(id, idhoadon);
            $("#tong").text(tong);
        }

        const Sum = () => {
            if ($("#tong").text() == '0') {
                alert('Không mua gì làm sao tính tổng?');
                return;
            }
            Common.An("intent2");
            Common.Hienthi("intent3");
            var tb = Index.setKetQua();
            var currentDate = Index.getCurrentDate();
            $('#ngay2').text($('#datePicker').val());
            $('#binhquan').text(tb);
            var a = $('#banggia2');
            currentDate.persons.forEach((val) => {
                var b = $(`<tr></tr>`);
                var c = $(`<td>${val.name}</td>`);
                var d = $(`<td>${val.tong}</td>`);
                var e = $(`<td>${val.conlai}</td>`);
                var g = $(`<td><input type="checkbox" id="cb${val.ID}" value="Thanh toán"> <label for="cb${val.ID}"> Thanh toán</label></td>`);
                b.append(c, d, e, g);
                a.append(b);
                var ava = val.avatar.indexOf("data") == 0 ? val.avatar : `img/${val.avatar}`
                var b1 = $(`<div class="col-2" id="member_${val.ID}" onclick="add2(this,${val.ID});">`);
                var c1 = $('<div class="row">');
                var d1 = $(`<img src="${ava}" alt="Avatar" class="avatar">`);
                var e1 = $('<div class="row">');
                var f1 = $(`<span>${val.name}</span>`);
                c1.append(d1);
                e1.append(f1);
                b1.append(c1, e1);
                $("#addout2").append(b1);
                Index.setEndResult();
            })
        }
        const back2 = () => {
            Common.An("intent3");
            Common.Hienthi("intent2");
            $('#ngay2').text('');
            $('#banggia2').empty();
            $("#addout2").empty();
            $("#addon2").empty();
            $('#tongcacu').text('0');
            $('#binhquan').text('');
        }

        const TinhNhanh = (e) => {
            var x = document.getElementById('btndacbiet');
            if (e.value == "Tính nhanh") {
                e.value = "Hủy";
                Common.Hienthi("tinhnhanh");
                Common.An("dacbiet");
                Common.An("tbtotal");
                $('#select2').empty();
                $('#btndacbiet').val('Đặc biệt');
            } else {
                e.value = "Tính nhanh";
                Common.An("tinhnhanh");
                Common.Hienthi("tbtotal",'table');
            }
        }

        const add2 = (ele, id) => {
            var e = $("#" + ele.id);
            var tong = Number($('#tongcacu').text())
            var currentDate = Index.getCurrentDate();
            if (e.parent().attr('id') == 'addon2') {//xoa
                $("#addout2").append(ele);
                var per = currentDate.persons;
                per.forEach((v) => {
                    if (v.ID == id) {
                        $('#tongcacu').text(tong - v.conlai);
                    }
                })
            } else {//them
                $("#addon2").append(ele);
                var per = currentDate.persons;
                per.forEach( (v) => {
                    if (v.ID == id) {
                        $('#tongcacu').text(tong + v.conlai);
                    }
                })
            }
        }
        const DacBiet = (e) => {
            if (e.value == "Đặc biệt") {
                e.value = "Hủy";
                Common.Hienthi("dacbiet");
                Common.An("tinhnhanh");
                Common.An("tbtotal");
                $('#btntinhnhanh').val("Tính nhanh");
                $('#select2').empty();
                var con = $('#selecthd').html();
                var sel = $('<select id="selectten">').appendTo('#select2');
                sel.append($(con))
            } else {
                e.value = "Đặc biệt";
                Common.Hienthi("tbtotal", 'table');
                Common.An("dacbiet");
            }
        }
        const Themdb = () => {
            // var count = 0;
            var currentDate = Index.getCurrentDate();
            var id= $("#selectten option:selected").val();
            var hasId = currentDate.dacbiet.find(v=>v.ID==id);
            if(hasId) {
                alert('Trùng tên rồi \n Chọn tên khác đi');
                return;
            }
            var tien = Number($("#txtGia2").val());
            if ($("#txtGia2").val() == '' || tien+currentDate.tongdb > currentDate.tong) {
                alert('Cao hơn tiền tổng rồi');
                return;
            }
            Index.addDacBiet(id,tien);
            var a = $('#banggia3');
            var b = $(`<tr id="trdb${id}"></tr>`);
            var c = $(`<td>${$("#selectten option:selected").text()}</td>`);
            var e = $(`<td>${tien}</td>`);
            var f = $(`<td><input type="button" value="Xóa" onclick="Delete2(${id})" /></td>`);
            b.append(c, e, f);
            a.append(b);;
        }
        const Delete2 = (id) => {
            $(`#trdb${id}`).remove();
            Index.delDacBiet(id);
        }

        const SumDB = ()=> {
            Index.setEndResult();
            var currentDate = Index.getCurrentDate();
            var a = $('#banggia4');
            a.empty();
            currentDate.endResult.forEach((val) => {
                var b = $(`<tr></tr>`);
                var c = $(`<td>${val.name}</td>`);
                var d = $(`<td>${val.tong}</td>`);
                var e = $(`<td>${val.conlai}</td>`);
                var g = $(`<td><input type="checkbox" id="cbdb${val.ID}" value="Thanh toán" onclick="Tattoan(this,${val.ID})"> <label for="cbdb${val.ID}"> Thanh toán</label><br></td>`);
                b.append(c, d, e, g);
                a.append(b);
            })
        }

        const Tattoan = (elem,id) =>{
            var check = elem.checked;
            Index.Tattoan(id,check);
        }
    </script>
</body>
</html>
